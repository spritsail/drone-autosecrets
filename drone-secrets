#!/bin/sh
set -e
set -o pipefail

# Only use error colours when stdout is a tty
if [ -t 2 ]; then
    RED='\033[0;31m'
    NC='\033[0m'
fi

error() { >&2 printf "${RED}${MSG:-Error}: $@${NC}"; exit 1; }

if [ $# -lt 1 ]; then
    MSG=Usage error "$(basename $0) <repo e.g. spritsail/test> [docker image repo]"
elif [ -z "$DRONE_SERVER" ]; then
    error "DRONE_SERVER variable is unset"
elif [ -z "$DRONE_TOKEN" ]; then
    error "DRONE_TOKEN variable is unset"
elif ! docker info >/dev/null 2>&1; then
    error "docker daemon isn't running"
fi

REPO="$1"
IMAGE="${2:-$1}"

# Refresh remote repo list
drone repo sync >/dev/null && echo "[*] drone: updated repository list"

if drone repo add "$REPO" 2>&1; then
    echo "[*] drone: enabled repo '${REPO}'"
    NEWREPO="true"
fi

drone repo update --trusted "$REPO" || true
echo "[*] drone: set repo to trusted"

{ gopass spritsail/drone.spritsail.io/env; echo; } | \
    while read secret; do
        name="$(echo ${secret%%:*} | xargs)"
        value="$(echo ${secret#*:} | xargs)"
        drone secret add --name="$name" --value="$value" "$REPO" ||
            drone secret update --name="$name" --value="$value" "$REPO"
    done

if [ "$NEWREPO" = "true" ]; then
    docker pull tianon/true
    docker tag tianon/true "$IMAGE"
    docker push "$REPO"
fi


MICROBADGER_API="https://api.microbadger.com/v1/images"
MICROBADGER_TOKEN="$(curl -fsSL "$MICROBADGER_API/$IMAGE" | jq -r .WebhookURL | sed 's|^.*/||g')"

if [ -n "$MICROBADGER_TOKEN" ]; then
    drone secret add --name=microbadger_token --value="$MICROBADGER_TOKEN" "$REPO"
fi
