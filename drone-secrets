#!/bin/sh
set -e
set -o pipefail

if [ $# -lt 1 ]; then
    >&2 echo "Usage: $(basename $0) <repo e.g. spritsail/test>"
    exit 1
fi

REPO="$1"

if ! drone repo add "$REPO" 2>&1; then
    NEWREPO=true
fi

if [ "$2" == "-t" -o "$2" == "--trusted" ]; then
    drone repo update --trusted "$REPO" || true
fi

{ gopass spritsail/drone.spritsail.io/env; echo; } | \
    while read secret; do
        name="$(echo ${secret%%:*} | xargs)"
        value="$(echo ${secret#*:} | xargs)"
        drone secret add --name="$name" --value="$value" "$REPO" ||
            drone secret update --name="$name" --value="$value" "$REPO"
    done

if [ "$NEWREPO" = "true" ]; then
    docker pull tianon/true
    docker tag tianon/true "$REPO"
    docker push "$REPO"
fi


MICROBADGER_API="https://api.microbadger.com/v1/images"
MICROBADGER_TOKEN="$(curl -fsSL "$MICROBADGER_API/$REPO" | jq -r .WebhookURL | sed 's|^.*/||g')"

if [ -n "$MICROBADGER_TOKEN" ]; then
    drone secret add --name=microbadger_token --value="$MICROBADGER_TOKEN" "$REPO"
fi
